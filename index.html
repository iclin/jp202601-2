<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Trip 2026 (Online)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Noto Sans JP (Êó•Á≥ªÈ¢®Ê†º) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Custom Config for Tailwind colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#FFFBF0',
                        'muji-text': '#2D3436',
                        'muji-gray': '#636E72',
                        'pop-red': '#FF7675',
                        'pop-blue': '#74B9FF',
                        'pop-green': '#55EFC4',
                        'pop-yellow': '#FFEAA7',
                        'pop-purple': '#A29BFE',
                        'pop-dark': '#2D3436',
                        'pop-accent': '#FF6B6B',
                    },
                    fontFamily: {
                        'sans': ['"Noto Sans JP"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.05)',
                        'pop': '0 4px 0px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFFBF0;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='12' viewBox='0 0 20 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9.8 12c0-5.523 4.477-10 10-10a10 10 0 0 1 10 10h-2a8 8 0 0 0-8-8 8 8 0 0 0-8 8h-2zM0 12a10 10 0 0 1 10-10 10 10 0 0 1 10 10h-2a8 8 0 0 0-8-8 8 8 0 0 0-8 8H0z' fill='%23E6DDC8' fill-opacity='0.6' fill-rule='evenodd'/%3E%3C/svg%3E");
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #2D3436;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .card-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .tab-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { transform: scale(1.1) translateX(-5px); background: white !important; box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important; border: 2px solid white; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.15em; }
    </style>
</head>
<body class="text-muji-text">

    <div id="app" class="relative min-h-screen pb-20">
        
        <!-- Header Image & Decoration -->
        <header class="relative w-full h-[280px] bg-white header-curve z-10 overflow-hidden">
            <img src="Gemini_Generated_Image_52y8m952y8m952y8.jpg" 
                 class="w-full h-full object-cover object-center transition-all duration-500 translate-x-8 scale-110" 
                 alt="Header Banner"
                 onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop';">
            <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div>

            <!-- Japan 2026 -->
            <div class="absolute top-4 right-20 z-20">
                <span class="text-[10px] font-black text-white bg-pop-dark/80 backdrop-blur-md px-3 py-1 rounded-full border border-white/20 shadow-md tracking-widest uppercase">
                    <i class="fa-solid fa-plane-up mr-1 text-pop-red"></i> Japan 2026
                </span>
            </div>

            <!-- Tab Â∞éËà™Ê¨Ñ -->
            <div class="absolute top-4 right-4 flex flex-col space-y-3 z-20">
                <button @click="currentTab = 'schedule'" :class="{'tab-active text-pop-blue': currentTab === 'schedule', 'bg-white/80 text-gray-500': currentTab !== 'schedule'}" 
                    class="tab-btn w-12 h-12 rounded-2xl backdrop-blur flex items-center justify-center shadow-md border border-white/40">
                    <i class="fa-solid fa-map-location-dot text-xl"></i>
                </button>
                <button @click="currentTab = 'info'" :class="{'tab-active text-pop-red': currentTab === 'info', 'bg-white/80 text-gray-500': currentTab !== 'info'}" 
                    class="tab-btn w-12 h-12 rounded-2xl backdrop-blur flex items-center justify-center shadow-md border border-white/40">
                    <i class="fa-solid fa-circle-info text-xl"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="{'tab-active text-pop-green': currentTab === 'shopping', 'bg-white/80 text-gray-500': currentTab !== 'shopping'}" 
                    class="tab-btn w-12 h-12 rounded-2xl backdrop-blur flex items-center justify-center shadow-md border border-white/40">
                    <i class="fa-solid fa-basket-shopping text-xl"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="{'tab-active text-pop-yellow': currentTab === 'expenses', 'bg-white/80 text-gray-500': currentTab !== 'expenses'}" 
                    class="tab-btn w-12 h-12 rounded-2xl backdrop-blur flex items-center justify-center shadow-md border border-white/40">
                    <i class="fa-solid fa-yen-sign text-xl"></i>
                </button>
            </div>
            
            <!-- ÂõõÂúã/Êù±‰∫¨‰πãÊóÖ -->
            <div class="absolute top-14 right-20 z-20">
                <div class="vertical-text bg-white/90 backdrop-blur-md py-5 px-3 rounded-full border border-white shadow-lg text-pop-dark font-black text-sm h-[220px] flex items-center justify-center">
                    ÂõõÂúã / Êù±‰∫¨‰πãÊóÖ
                    <span class="mt-2 text-pop-red text-xs">‚óè</span>
                </div>
            </div>

            <!-- ÂêåÊ≠•ÁãÄÊÖãÊåáÁ§∫Ááà -->
            <div class="absolute top-4 left-4 z-20 flex items-center gap-2">
                <div class="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-[10px] font-bold text-gray-600 shadow-sm flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2" :class="dbStatus === 'connected' ? 'bg-green-500 animate-pulse' : 'bg-red-400'"></div>
                    {{ dbStatus === 'connected' ? 'Â∑≤ÈÄ£Á∑öÂêåÊ≠•‰∏≠' : (dbStatus === 'error' ? 'ÈÄ£Á∑öÈåØË™§' : 'Èõ¢Á∑öÊ®°Âºè') }}
                </div>
            </div>
        </header>

        <!-- ‰∏ªÂÖßÂÆπÂçÄ -->
        <main class="relative z-0 -mt-6 pt-10 px-4 min-h-[60vh]">
            
            <!-- 1. Ë°åÁ®ãË°® Tab -->
            <div v-if="currentTab === 'schedule'" class="animate-fade-in">
                <!-- Â§©Ê∞£Ë≥áË®ä Widget -->
                <div class="bg-gradient-to-r from-pop-blue to-blue-400 rounded-3xl p-5 shadow-pop mb-6 flex items-center justify-between text-white relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/20 rounded-full blur-xl"></div>
                    <div class="relative z-10">
                        <p class="text-xs opacity-80 mb-1 font-bold tracking-wider">CURRENT WEATHER</p>
                        <h2 class="text-2xl font-black tracking-wide">{{ weatherData.location }}</h2>
                    </div>
                    <div class="flex items-center space-x-4 relative z-10">
                        <div class="text-center">
                            <i :class="weatherData.icon" class="text-3xl drop-shadow-md text-pop-yellow"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-bold">{{ weatherData.temp }}¬∞</p>
                            <p class="text-xs opacity-80">È´îÊÑü {{ weatherData.feelsLike }}¬∞C</p>
                        </div>
                    </div>
                </div>

                <!-- Êó•ÊúüÈÅ∏ÂñÆ -->
                <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-4 mb-2 pl-1">
                    <div v-for="(day, index) in tripDays" :key="index" 
                         @click="selectedDayIndex = index"
                         :class="{'bg-pop-dark text-white shadow-pop scale-105 ring-2 ring-pop-dark ring-offset-2': selectedDayIndex === index, 'bg-white text-gray-400 border border-gray-100': selectedDayIndex !== index}"
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 cursor-pointer">
                        <span class="text-[10px] font-bold uppercase tracking-wider">{{ day.week }}</span>
                        <span class="text-2xl font-black mt-1 font-mono">{{ day.date }}</span>
                    </div>
                </div>

                <!-- ÁØ©ÈÅ∏ËàáÊ®ôÈ°å -->
                <div class="flex justify-between items-end mb-5">
                    <div>
                        <h3 class="text-2xl font-black text-pop-dark flex items-center">
                            <span class="text-pop-red mr-2">Day {{ selectedDayIndex + 1 }}</span>
                        </h3>
                        <p class="text-sm font-medium text-gray-500 mt-1 flex items-center">
                            <i class="fa-regular fa-calendar mr-2"></i> {{ currentFullDate }}
                        </p>
                    </div>
                    <select v-model="filterCategory" class="bg-white border border-gray-200 text-sm font-bold rounded-xl px-4 py-2 shadow-sm focus:ring-2 focus:ring-pop-blue outline-none text-gray-600">
                        <option value="All">ÂÖ®ÈÉ®Ë°åÁ®ã</option>
                        <option value="sightseeing">üå∏ ÊôØÈªû</option>
                        <option value="hotel">üè® ‰ΩèÂÆø</option>
                        <option value="food">üç± ÁæéÈ£ü</option>
                        <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                        <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                    </select>
                </div>

                <!-- Ë°åÁ®ãÂàóË°® -->
                <div class="space-y-0 relative">
                    <!-- Á¨¨‰∏ÄÂÄãË°åÁ®ã‰∫§ÈÄö -->
                    <div v-if="filteredEvents.length > 0" class="flex flex-col items-center mb-4 opacity-70">
                         <div class="text-xs bg-gray-200/80 px-3 py-1 rounded-full text-gray-600 mb-1 flex items-center gap-1 font-medium">
                            <i class="fa-solid fa-bed text-pop-purple"></i>
                            Âæû {{ previousHotel }} Âá∫Áôº
                        </div>
                        <div class="h-6 border-l-2 border-dashed border-gray-300"></div>
                        <div class="text-xs font-bold text-gray-500 bg-white px-3 py-1 rounded-lg border border-gray-100 shadow-sm z-10 -mt-3 flex items-center gap-1">
                            <i :class="getTransportIcon(filteredEvents[0].transportType)" class="text-pop-blue"></i>
                            {{ filteredEvents[0].transportTime || 'Ë®àÁÆó‰∏≠...' }}
                        </div>
                    </div>

                    <div v-for="(event, index) in filteredEvents" :key="event.id" 
                         class="relative group"
                         draggable="true"
                         @dragstart="dragStart(index)"
                         @dragover.prevent
                         @drop="drop(index)">
                        
                        <!-- ‰∫§ÈÄöÊôÇÈñì -->
                        <div v-if="index > 0" class="flex flex-col items-center my-1">
                            <div class="h-4 border-l-2 border-dashed border-gray-300"></div>
                            <div class="text-xs font-bold text-gray-500 bg-white px-3 py-1 rounded-lg border border-gray-100 shadow-sm z-10 -mt-2 flex items-center gap-1">
                                <i :class="getTransportIcon(event.transportType)" class="text-pop-blue"></i>
                                {{ event.transportTime || '15 mins' }}
                            </div>
                            <div class="h-4 border-l-2 border-dashed border-gray-300"></div>
                        </div>

                        <!-- Ë°åÁ®ãÂç°Áâá -->
                        <div class="card-glass rounded-2xl p-5 shadow-soft relative overflow-hidden bg-white"
                             :class="{'border-l-[6px] border-l-pop-blue': event.type === 'sightseeing', 
                                      'border-l-[6px] border-l-pop-red': event.type === 'food',
                                      'border-l-[6px] border-l-pop-yellow': event.type === 'flight',
                                      'border-l-[6px] border-l-pop-green': event.type === 'shopping',
                                      'border-l-[6px] border-l-gray-400': event.type === 'hotel'}">
                            
                            <!-- Ëà™Áè≠Ê®£Âºè -->
                            <div v-if="event.type === 'flight'" class="flex flex-col">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-[10px] font-black tracking-widest bg-pop-yellow text-yellow-800 px-2 py-1 rounded-md">FLIGHT</span>
                                    <span class="text-xs font-mono font-bold text-gray-500">{{ event.startTime }} - {{ event.endTime }}</span>
                                </div>
                                <div class="flex items-center justify-between px-2">
                                    <div class="text-center">
                                        <div class="text-3xl font-black text-pop-dark tracking-tighter">{{ event.flightFrom }}</div>
                                    </div>
                                    <div class="flex flex-col items-center px-4">
                                        <i class="fa-solid fa-plane text-pop-yellow transform rotate-45 text-xl"></i>
                                        <span class="text-[10px] text-gray-400 mt-1 font-bold">{{ event.flightDuration }}</span>
                                        <div class="w-full h-[2px] bg-gray-100 mt-1 rounded-full relative overflow-hidden">
                                            <div class="absolute left-0 top-0 h-full w-1/2 bg-pop-yellow"></div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-black text-pop-dark tracking-tighter">{{ event.flightTo }}</div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center text-sm font-bold text-gray-600 bg-gray-50 py-1 rounded-lg">
                                    {{ event.name }} ({{ event.flightCode }})
                                </div>
                            </div>

                            <!-- ‰∏ÄËà¨Ê®£Âºè -->
                            <div v-else>
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg text-pop-dark leading-tight">{{ event.name }}</h4>
                                    <span v-if="event.startTime" class="flex-shrink-0 text-xs font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded-md ml-2 font-mono">
                                        {{ event.startTime }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mb-3 leading-relaxed" v-if="event.note">{{ event.note }}</p>
                                <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                                    <span v-if="event.ticket" class="text-[10px] font-bold border border-pop-blue text-pop-blue px-3 py-1 rounded-full whitespace-nowrap bg-blue-50">
                                        <i class="fa-solid fa-ticket mr-1"></i>{{ event.ticket }}
                                    </span>
                                    <span class="text-[10px] font-bold border border-gray-200 text-gray-400 px-3 py-1 rounded-full whitespace-nowrap">
                                        #{{ event.type }}
                                    </span>
                                </div>
                            </div>

                            <!-- Êìç‰ΩúÊåâÈàï -->
                            <div class="flex gap-3 mt-4 pt-3 border-t border-gray-100">
                                <button @click.stop="editEvent(event)" class="flex-1 bg-gray-50 text-gray-600 py-2.5 rounded-xl text-xs font-bold hover:bg-gray-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-pen-to-square"></i> ‰øÆÊîπ
                                </button>
                                <button @click.stop="openMap(event.name)" class="flex-1 bg-pop-blue text-white py-2.5 rounded-xl text-xs font-bold hover:bg-blue-400 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-sm shadow-blue-100">
                                    <i class="fa-solid fa-location-arrow"></i> Â∞éËà™
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="filteredEvents.length === 0" class="text-center py-16 text-gray-300">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-regular fa-calendar-xmark text-3xl text-gray-300"></i>
                        </div>
                        <p class="font-bold">Êú¨Êó•Â∞öÁÑ°Ë°åÁ®ã</p>
                        <p class="text-xs mt-1">ÈªûÊìäÂè≥‰∏ãËßí + Êñ∞Â¢û</p>
                    </div>
                </div>

                <div class="h-28"></div>
                <button @click="openAddModal" class="fixed bottom-8 right-6 w-16 h-16 bg-pop-accent text-white rounded-2xl shadow-pop flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition-all z-30 ring-4 ring-white">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- ÂÖ∂‰ªñ Tab ÂÖßÂÆπ (Info, Shopping, Expenses) -->
            <!-- Ë≥áË®ä Tab -->
            <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                <!-- ÂåØÁéá -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-muji-text mb-4 border-l-4 border-pop-yellow pl-3 text-lg flex items-center">
                        <i class="fa-solid fa-coins text-pop-yellow mr-2"></i> ÂåØÁéáÊèõÁÆó
                    </h3>
                    <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-2xl">
                        <div class="flex-1 bg-white rounded-xl p-3 shadow-sm">
                            <label class="text-[10px] font-bold text-gray-400 block mb-1">Êó•Âπ£ (JPY)</label>
                            <input type="number" v-model="currencyInput" class="w-full text-xl font-mono font-bold outline-none text-pop-dark" placeholder="0">
                        </div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                        <div class="flex-1 bg-white rounded-xl p-3 shadow-sm border border-pop-yellow">
                            <label class="text-[10px] font-bold text-gray-400 block mb-1">Âè∞Âπ£ (TWD)</label>
                            <div class="w-full text-xl font-mono font-bold text-pop-dark">{{ convertedCurrency }}</div>
                        </div>
                    </div>
                    <p class="text-right text-[10px] font-bold text-gray-400 mt-2">ÂåØÁéá: {{ exchangeRate }}</p>
                </div>
                <!-- Ëà™Áè≠ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-muji-text mb-4 border-l-4 border-pop-blue pl-3 text-lg flex items-center">
                        <i class="fa-solid fa-plane text-pop-blue mr-2"></i> Ëà™Áè≠Ë≥áË®ä
                    </h3>
                    <!-- ÈùúÊÖãËà™Áè≠ÂàóË°® (Á∂≠ÊåÅ‰∏çËÆä) -->
                    <div class="mb-5 pb-5 border-b border-dashed border-gray-200">
                        <div class="flex justify-between text-sm font-bold mb-2">
                            <span class="bg-pop-blue text-white px-2 py-0.5 rounded text-xs">ÂéªÁ®ã</span>
                            <span class="font-mono text-gray-500">2026.01.29</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-center"><div class="text-3xl font-black text-pop-dark">RMQ</div><div class="text-xs font-bold text-gray-400">08:50</div></div>
                            <div class="text-xs text-gray-400 flex flex-col items-center w-full px-2">
                                <span class="font-bold text-pop-blue">JX300</span>
                                <span class="text-[10px] text-gray-400 scale-90 bg-gray-100 px-1 rounded mt-0.5">(FRGX8S)</span>
                                <div class="w-full h-[2px] bg-gray-200 my-1 relative">
                                    <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-300 text-[10px]"></i>
                                </div>
                            </div>
                            <div class="text-center"><div class="text-3xl font-black text-pop-dark">TAK</div><div class="text-xs font-bold text-gray-400">12:20</div></div>
                        </div>
                    </div>
                    <!-- (...ÁúÅÁï•ÈáçË§áÁöÑËà™Áè≠ËàáÁßüËªäË≥áË®äÔºå‰øùÊåÅÂéüÊ®£) -->
                </div>
            </div>

            <!-- Ë≥ºÁâ© Tab -->
            <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-24">
                <h3 class="font-black text-muji-text mb-6 text-2xl flex items-center">
                    <span class="bg-pop-green text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm mr-2 shadow-sm"><i class="fa-solid fa-basket-shopping"></i></span>
                    Shopping List 
                    <span class="text-sm font-bold text-gray-400 ml-2 bg-gray-100 px-2 py-1 rounded-full">({{ shoppingList.length }})</span>
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-3xl overflow-hidden shadow-sm relative group border border-gray-100">
                        <div class="h-36 bg-gray-100 overflow-hidden relative">
                             <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                             <div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-300 bg-gray-50">
                                <i class="fa-solid fa-image text-3xl mb-2"></i>
                                <span class="text-[10px]">ÁÑ°ÂúñÁâá</span>
                             </div>
                             <button @click="deleteShoppingItem(index)" class="absolute top-2 right-2 bg-black/60 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs backdrop-blur-sm shadow-sm active:scale-90 transition-transform">
                                <i class="fa-solid fa-times"></i>
                             </button>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-gray-800 truncate mb-2">{{ item.name }}</h4>
                            <div class="flex items-center mt-1 text-xs font-bold text-gray-500 bg-gray-50 p-2 rounded-lg cursor-pointer" @click="toggleShopItem(index)">
                                <div class="w-4 h-4 rounded border-2 border-pop-green mr-2 flex items-center justify-center" :class="{'bg-pop-green': item.checked}">
                                    <i v-if="item.checked" class="fa-solid fa-check text-white text-[10px]"></i>
                                </div>
                                <span :class="{'line-through text-gray-300': item.checked}">{{ item.checked ? 'Â∑≤Ë≥ºË≤∑' : 'ÂæÖË≥ºË≤∑' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="showShoppingModal = true" class="fixed bottom-8 right-6 w-16 h-16 bg-pop-green text-white rounded-2xl shadow-pop flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition-all z-30 ring-4 ring-white">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- Ëä±Ë≤ª Tab -->
            <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-24">
                <div class="bg-gradient-to-br from-pop-yellow to-yellow-200 rounded-3xl p-6 text-center mb-6 shadow-pop relative overflow-hidden">
                    <i class="fa-solid fa-yen-sign absolute -left-4 -bottom-4 text-9xl text-white opacity-30 transform rotate-12"></i>
                    <p class="text-sm font-bold text-yellow-800 opacity-70 mb-1 uppercase tracking-wider">Total Expenses</p>
                    <h2 class="text-5xl font-black text-yellow-900 tracking-tighter">¬•{{ totalExpenses.toLocaleString() }}</h2>
                    <div class="inline-block bg-white/40 backdrop-blur-sm px-3 py-1 rounded-full mt-3">
                        <p class="text-xs font-bold text-yellow-900">Á¥Ñ NT$ {{ (totalExpenses * exchangeRate).toFixed(0).toLocaleString() }}</p>
                    </div>
                </div>
                <div class="bg-white rounded-t-[40px] shadow-sm min-h-[50vh] p-6 -mx-4">
                    <h3 class="font-bold text-gray-700 mb-6 px-2 flex items-center"><i class="fa-solid fa-list-ul mr-2 text-gray-400"></i> ÊîØÂá∫Á¥ÄÈåÑ</h3>
                    <div class="space-y-4">
                        <div v-for="(expense, index) in expenses" :key="index" class="flex justify-between items-center border-b border-gray-50 pb-4 last:border-0 px-2">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-sm text-lg" :class="{'bg-pop-red': expense.category === 'food', 'bg-pop-blue': expense.category === 'transport', 'bg-pop-green': expense.category === 'shopping', 'bg-gray-400': expense.category === 'hotel', 'bg-pop-purple': expense.category === 'ticket', 'bg-gray-300': expense.category === 'other'}">
                                    <i :class="getCategoryIcon(expense.category)"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-base text-gray-800">{{ expense.name }}</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-0.5 bg-gray-100 px-2 py-0.5 rounded inline-block">{{ expense.date }} ¬∑ {{ expense.payment }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold text-lg text-gray-800">-¬•{{ Number(expense.amount).toLocaleString() }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="showExpenseModal = true" class="fixed bottom-8 right-6 w-16 h-16 bg-pop-yellow text-yellow-800 rounded-2xl shadow-pop flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition-all z-30 ring-4 ring-white">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

        </main>

        <!-- Modals ‰øùÊåÅ‰∏çËÆä (ÁúÅÁï•ÈÉ®ÂàÜÈáçË§á‰ª£Á¢ºÔºåÂäüËÉΩÈÇèËºØÂú®‰∏ãÊñπ JS Êõ¥Êñ∞) -->
        <!-- Ë°åÁ®ãÁ∑®ËºØ Modal -->
        <div v-if="showEventModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-pop-dark/40 backdrop-blur-sm pointer-events-auto transition-opacity" @click="closeEventModal"></div>
            <div class="relative z-10 bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pointer-events-auto animate-slide-up shadow-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-black mb-6 text-center text-pop-dark flex items-center justify-center">
                    <i class="fa-solid fa-pen-nib text-pop-blue mr-2"></i> {{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">Êó•Êúü</label>
                        <select v-model="eventForm.dayIndex" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold text-gray-700 outline-none border border-gray-100">
                            <option v-for="(day, idx) in tripDays" :value="idx" :key="idx">{{ day.date }} ({{ day.week }})</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">ÂêçÁ®±</label>
                        <input type="text" v-model="eventForm.name" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold border-b-2 border-transparent focus:border-pop-blue outline-none placeholder-gray-300" placeholder="Ëº∏ÂÖ•Âú∞ÈªûÊàñÊ¥ªÂãïÂêçÁ®±">
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">ÈñãÂßãÊôÇÈñì</label>
                            <input type="time" v-model="eventForm.startTime" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold text-gray-700 outline-none">
                        </div>
                        <div class="flex-1">
                             <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">È°ûÂà•</label>
                             <select v-model="eventForm.type" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold text-gray-700 outline-none">
                                 <option value="sightseeing">üå∏ ÊôØÈªû</option>
                                 <option value="food">üç± ÁæéÈ£ü</option>
                                 <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                                 <option value="hotel">üè® ‰ΩèÂÆø</option>
                                 <option value="other">‚ú® ÂÖ∂‰ªñ</option>
                             </select>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <label class="text-xs font-bold text-pop-blue block mb-2 uppercase tracking-wide"><i class="fa-solid fa-route mr-1"></i> ‰∫§ÈÄö (Âæû‰∏ä‰∏ÄÁ´ô)</label>
                        <div class="flex gap-2">
                             <select v-model="eventForm.transportType" class="bg-white rounded-lg p-2 text-sm font-bold w-1/3 shadow-sm text-gray-600">
                                 <option value="walk">üö∂ Ê≠•Ë°å</option>
                                 <option value="train">üöÉ ÈõªËªä</option>
                                 <option value="car">üöó ÈñãËªä</option>
                             </select>
                             <input type="text" v-model="eventForm.transportTime" placeholder="È†ê‰º∞ÊôÇÈñì (‰æã: 15ÂàÜ)" class="bg-white rounded-lg p-2 text-sm font-bold flex-1 shadow-sm placeholder-gray-300">
                        </div>
                    </div>
                    <div v-if="eventForm.type === 'sightseeing'">
                        <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">ÈñÄÁ•®Ë≥áË®ä</label>
                        <input type="text" v-model="eventForm.ticket" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold" placeholder="ÈáëÈ°çÊàñÈ†êÁ¥ÑÁãÄÊÖã">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide">ÂÇôË®ª</label>
                        <textarea v-model="eventForm.note" class="w-full bg-gray-50 rounded-xl p-3 text-sm h-20 font-medium text-gray-600 placeholder-gray-300" placeholder="ÁâπËâ≤„ÄÅÂøÖÂêÉ„ÄÅÊ≥®ÊÑè‰∫ãÈ†Ö..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-red-50 text-red-400 py-3.5 rounded-xl font-black text-sm hover:bg-red-100 transition-colors">Âà™Èô§</button>
                    <button @click="saveEvent" class="flex-[2] bg-pop-accent text-white py-3.5 rounded-xl font-black text-sm shadow-lg shadow-red-200 hover:shadow-xl active:scale-95 transition-all">ÂÑ≤Â≠òË°åÁ®ã</button>
                </div>
            </div>
        </div>

        <!-- Ë≥ºÁâ© Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-pop-dark/40 backdrop-blur-sm pointer-events-auto transition-opacity" @click="showShoppingModal = false"></div>
            <div class="relative z-10 bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pointer-events-auto animate-slide-up">
                <h3 class="text-xl font-black mb-6 text-center text-pop-dark">Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ</h3>
                <div class="space-y-4">
                    <input type="text" v-model="shoppingForm.name" class="w-full bg-gray-50 rounded-xl p-4 text-base font-bold placeholder-gray-300 outline-none focus:ring-2 focus:ring-pop-green" placeholder="ÊÉ≥Ë≤∑‰ªÄÈ∫ºÔºü">
                    <div class="relative w-full h-40 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-100 hover:border-pop-green transition-colors group">
                        <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                        <i v-if="!shoppingForm.image" class="fa-solid fa-camera text-3xl mb-2 group-hover:text-pop-green transition-colors"></i>
                        <span v-if="!shoppingForm.image" class="text-xs font-bold">ÈªûÊìä‰∏äÂÇ≥ÂèÉËÄÉÂúñÁâá</span>
                        <img v-if="shoppingForm.image" :src="shoppingForm.image" class="absolute inset-0 w-full h-full object-cover rounded-2xl">
                    </div>
                </div>
                <button @click="addShoppingItem" class="w-full bg-pop-green text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-green-100 mt-8 active:scale-95 transition-transform">Âä†ÂÖ•Ê∏ÖÂñÆ</button>
            </div>
        </div>

        <!-- Ëä±Ë≤ª Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-pop-dark/40 backdrop-blur-sm pointer-events-auto transition-opacity" @click="showExpenseModal = false"></div>
            <div class="relative z-10 bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pointer-events-auto animate-slide-up">
                <h3 class="text-xl font-black mb-6 text-center text-pop-dark">Âø´ÈÄüË®òÂ∏≥</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" v-model="expenseForm.date" class="bg-gray-50 rounded-xl p-3 text-sm font-bold text-gray-600 outline-none">
                        <select v-model="expenseForm.category" class="bg-gray-50 rounded-xl p-3 text-sm font-bold text-gray-600 outline-none">
                            <option value="food">üç± È£≤È£ü</option>
                            <option value="transport">üöÑ ‰∫§ÈÄö</option>
                            <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                            <option value="hotel">üè® ‰ΩèÂÆø</option>
                            <option value="ticket">üé´ ÈñÄÁ•®</option>
                            <option value="other">üí∏ ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <input type="text" v-model="expenseForm.name" class="w-full bg-gray-50 rounded-xl p-4 text-sm font-bold placeholder-gray-300 outline-none focus:ring-2 focus:ring-pop-yellow" placeholder="Ê∂àË≤ªÈ†ÖÁõÆ">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 font-bold text-gray-400">¬•</span>
                        <input type="number" v-model="expenseForm.amount" class="w-full bg-gray-50 rounded-xl p-4 pl-8 text-lg font-mono font-bold placeholder-gray-300 outline-none focus:ring-2 focus:ring-pop-yellow" placeholder="ÈáëÈ°ç">
                    </div>
                    <div class="flex gap-3 text-sm font-bold">
                        <button @click="expenseForm.payment='Cash'" :class="{'bg-pop-yellow text-yellow-900 border-pop-yellow': expenseForm.payment==='Cash', 'bg-white text-gray-400 border-gray-200': expenseForm.payment!=='Cash'}" class="flex-1 py-3 rounded-xl border-2 transition-colors">ÁèæÈáë</button>
                        <button @click="expenseForm.payment='Card'" :class="{'bg-pop-blue text-white border-pop-blue': expenseForm.payment==='Card', 'bg-white text-gray-400 border-gray-200': expenseForm.payment!=='Card'}" class="flex-1 py-3 rounded-xl border-2 transition-colors">‰ø°Áî®Âç°</button>
                    </div>
                </div>
                <button @click="addExpense" class="w-full bg-pop-dark text-white py-4 rounded-2xl font-black text-sm shadow-lg mt-8 active:scale-95 transition-transform">ÂÑ≤Â≠òÁ¥ÄÈåÑ</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK & Vue Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // -----------------------------------------------------------
        // ‚ö†Ô∏è ‰∏äÂÇ≥Âà∞ GITHUB Ë´ãÁúãÈÄôË£° ‚ö†Ô∏è
        // Ëã•ÊÇ®ÈÉ®ÁΩ≤Âà∞ GitHub PagesÔºåË´ãÂú® Firebase Console Âª∫Á´ã‰∏ÄÂÄãÂÖçË≤ªÂ∞àÊ°à
        // ÁÑ∂ÂæåÂ∞á‰∏ãÊñπÁöÑ firebaseConfig ÂÖßÂÆπÊõøÊèõÊàêÊÇ®Ëá™Â∑±ÁöÑË®≠ÂÆö
        // -----------------------------------------------------------
        let firebaseConfig = {
          apiKey: "AIzaSyBV6yaJDYngkoEE7noUWFAVtPnbZ44FE4g",
          authDomain: "tokyo-de9c2.firebaseapp.com",
          projectId: "tokyo-de9c2",
          storageBucket: "tokyo-de9c2.firebasestorage.app",
          messagingSenderId: "507128042786",
          appId: "1:507128042786:web:e4a78f53d32ed73ef0017b",
          measurementId: "G-31RSNG5HGC"
        };
        let appId = 'japan-trip-2026';

        // Ëá™ÂãïÂÅµÊ∏¨Áí∞Â¢É (Canvas È†êË¶ΩÊôÇË¶ÜËìãÔºåÈÉ®ÁΩ≤Âæå‰ΩøÁî®‰∏äÈù¢ÁöÑË®≠ÂÆö)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config); 
            if (typeof __app_id !== 'undefined') appId = __app_id;
        }

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // Firebase State
                const dbStatus = ref('disconnected');
                let db = null;
                let auth = null;

                // App State
                const currentTab = ref('schedule');
                const selectedDayIndex = ref(0);
                const filterCategory = ref('All');
                const exchangeRate = ref(0.22);
                const currencyInput = ref('');
                
                const tripDays = [
                    { date: '29', week: 'Thu', fullDate: '2026-01-29' }, { date: '30', week: 'Fri', fullDate: '2026-01-30' },
                    { date: '31', week: 'Sat', fullDate: '2026-01-31' }, { date: '01', week: 'Sun', fullDate: '2026-02-01' },
                    { date: '02', week: 'Mon', fullDate: '2026-02-02' }, { date: '03', week: 'Tue', fullDate: '2026-02-03' },
                    { date: '04', week: 'Wed', fullDate: '2026-02-04' }, { date: '05', week: 'Thu', fullDate: '2026-02-05' },
                    { date: '06', week: 'Fri', fullDate: '2026-02-06' }
                ];

                const staticInfo = {
                    hotels: [
                        { day: 'Day 1', name: 'Remm Tokyo Kyobashi', address: '2-6-21 Kyobashi, Tokyo, 104-0031, JP' },
                        { day: 'Day 2-3', name: 'JR West Group VIA INN Prime', address: '16-12 Nihonbashikoami-cho, Tokyo' },
                        { day: 'Day 4', name: 'Daiwa Roynet Hotel Tokushima', address: '3-8, Terashimahonmachi-higashi' },
                        { day: 'Day 5', name: 'Dormy Inn Kochi', address: '1-9-12, Obiyamachi, Kochi' },
                        { day: 'Day 6', name: 'Dormy Inn Matsuyama', address: '2 Chome-6-5 Okaido, Matsuyama' },
                        { day: 'Day 7-8', name: 'Daiwa Roynet Hotel Takamatsu', address: '8-23, Marugame-machi, Takamatsu' }
                    ]
                };

                const hotelMap = { 0: 'Remm Tokyo Kyobashi', 1: 'JR West Group VIA INN', 2: 'JR West Group VIA INN', 3: 'Daiwa Roynet Tokushima', 4: 'Dormy Inn Kochi', 5: 'Dormy Inn Matsuyama', 6: 'Daiwa Roynet Takamatsu', 7: 'Daiwa Roynet Takamatsu', 8: 'Sweet Home' };

                // ÈüøÊáâÂºèË≥áÊñô (È†êË®≠Á©∫ÂÄºÔºåÁ≠âÂæÖ Firebase ‰∏ãËºâ)
                // ‰øÆÊ≠£Ôºö‰ΩøÁî® Array.from Âª∫Á´ãÁç®Á´ãÁöÑÈô£ÂàóÔºåÈÅøÂÖç‰øÆÊîπÊüê‰∏ÄÂ§©ÈÄ£ÂãïÂà∞ÂÖ∂‰ªñÂ§©ÁöÑ Bug
                const scheduleData = ref(Array.from({ length: 9 }, () => []));
                const shoppingList = ref([]);
                const expenses = ref([]);

                // Modals
                const showEventModal = ref(false);
                const isEditing = ref(false);
                const eventForm = ref({});
                const showShoppingModal = ref(false);
                const shoppingForm = ref({ name: '', image: null });
                const showExpenseModal = ref(false);
                const expenseForm = ref({ date: new Date().toISOString().split('T')[0], category: 'food', payment: 'Cash', amount: '' });

                // ÂàùÂßãÂåñ Firebase
                onMounted(async () => {
                    if (firebaseConfig) {
                        try {
                            const app = initializeApp(firebaseConfig);
                            auth = getAuth(app);
                            db = getFirestore(app);
                            
                            // ‰øÆÊ≠£ÔºöÊ™¢Êü•ÊòØÂê¶ÊúâËá™Ë®Ç‰ª§Áâå (È†êË¶ΩÁí∞Â¢ÉÁî®)ÔºåÂê¶Ââá‰ΩøÁî®ÂåøÂêçÁôªÂÖ• (GitHub PagesÁî®)
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            
                            dbStatus.value = 'connected';

                            // Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩ (Real-time Listeners)
                            // 1. Áõ£ËÅΩË°åÁ®ã (Âä†ÂÖ•ÈåØË™§ÂõûË™ø)
                            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'shared_trip', 'schedule'), (docSnap) => {
                                if (docSnap.exists()) {
                                    // ‰øÆÊ≠£ÔºöÂ¶ÇÊûúÂ≠òÁöÑÊòØÂ≠ó‰∏≤(ÁÇ∫‰∫ÜÈÅøÈñãNest ArrayÈôêÂà∂)ÔºåÂâáParseÂõû‰æÜ
                                    const remoteData = docSnap.data().data;
                                    scheduleData.value = (typeof remoteData === 'string') ? JSON.parse(remoteData) : remoteData;
                                } else {
                                    saveToCloud('schedule', scheduleData.value);
                                }
                            }, (error) => {
                                console.error("Schedule listener error:", error);
                                dbStatus.value = 'error';
                            });
                            
                            // 2. Áõ£ËÅΩË≥ºÁâ©
                            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'shared_trip', 'shopping'), (docSnap) => {
                                if (docSnap.exists()) shoppingList.value = docSnap.data().data;
                            }, (error) => console.error("Shopping listener error:", error));
                            
                            // 3. Áõ£ËÅΩËä±Ë≤ª
                            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'shared_trip', 'expenses'), (docSnap) => {
                                if (docSnap.exists()) expenses.value = docSnap.data().data;
                            }, (error) => console.error("Expenses listener error:", error));

                        } catch (e) {
                            console.error("Firebase init failed:", e);
                            dbStatus.value = 'error';
                            // ÈôçÁ¥ö‰ΩøÁî® localStorage ‰ª•Èò≤Ëê¨‰∏Ä
                            loadLocal();
                        }
                    } else {
                        // ÁÑ° ConfigÔºå‰ΩøÁî® LocalStorage
                        console.warn("No Firebase Config found. Using LocalStorage.");
                        loadLocal();
                    }
                });

                // Êú¨Âú∞ËºâÂÖ• (ÂÇôÁî®)
                const loadLocal = () => {
                    const savedSchedule = localStorage.getItem('scheduleData');
                    if (savedSchedule) scheduleData.value = JSON.parse(savedSchedule);
                    else {
                        // È†êË®≠Ë°åÁ®ãË≥áÊñô
                        scheduleData.value = [
                            [{ id: 101, type: 'flight', name: 'Âè∞‰∏≠ -> È´òÊùæ', flightFrom: 'RMQ', flightTo: 'TAK', flightCode: 'JX300', startTime: '08:50', endTime: '12:20', flightDuration: '2h 30m', transportType: 'car', transportTime: 'Âá∫Áôº' }, { id: 102, type: 'flight', name: 'È´òÊùæ -> ÁæΩÁî∞', flightFrom: 'TAK', flightTo: 'HND', flightCode: 'JL482', startTime: '15:25', endTime: '16:45', flightDuration: '1h 20m', transportType: 'train', transportTime: 'Ê©üÂ†¥ËΩâ‰πò' }, { id: 103, type: 'hotel', name: 'Remm Tokyo Kyobashi Check-in', startTime: '18:00', transportType: 'train', transportTime: '45 mins' }],
                            [], [], 
                            [{ id: 401, type: 'flight', name: 'ÁæΩÁî∞ -> Âæ∑Â≥∂', flightFrom: 'HND', flightTo: 'TKS', flightCode: 'JL455', startTime: '10:15', endTime: '11:35', flightDuration: '1h 20m', transportType: 'train', transportTime: '40 mins' }, { id: 402, type: 'other', name: 'ÂèñËªä (Âæ∑Â≥∂Ê©üÂ†¥)', startTime: '12:00', transportType: 'walk', transportTime: '5 mins', note: 'Toyota Rent a Car' }],
                            [], [], [], [], 
                            [{ id: 901, type: 'other', name: 'ÈÇÑËªä (È´òÊùæÊ©üÂ†¥)', startTime: '12:00', transportType: 'car', transportTime: '30 mins' }, { id: 902, type: 'flight', name: 'È´òÊùæ -> Âè∞‰∏≠', flightFrom: 'TAK', flightTo: 'RMQ', flightCode: 'JX301', startTime: '13:20', endTime: '15:40', flightDuration: '3h 20m', transportType: 'walk', transportTime: '5 mins' }]
                        ];
                    }
                    const savedShop = localStorage.getItem('shoppingList');
                    if (savedShop) shoppingList.value = JSON.parse(savedShop);
                    const savedExp = localStorage.getItem('expenses');
                    if (savedExp) expenses.value = JSON.parse(savedExp);
                };

                // Èò≤ÊâãÊäñÂ≠òÊ™î (Debounce Save) - ‰øÆÊ≠£ÔºöÈáùÂ∞ç‰∏çÂêåÈ°ûÂûã‰ΩøÁî®‰∏çÂêå timerÔºåÈÅøÂÖç‰∫íÁõ∏Âπ≤Êìæ
                const debounceTimers = {};
                const saveToCloud = (type, data) => {
                    if (dbStatus.value === 'connected') {
                        // Firestore Save
                        clearTimeout(debounceTimers[type]);
                        debounceTimers[type] = setTimeout(() => {
                            // ‰øÆÊ≠£ÔºöÈáùÂ∞ç schedule (Â∑¢ÁãÄÈô£Âàó) ÈÄ≤Ë°å stringifyÔºåÈÅøÈñã Firestore ÈôêÂà∂
                            let payload = data;
                            if (type === 'schedule') {
                                payload = JSON.stringify(data);
                            }
                            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shared_trip', type), { data: payload })
                                .catch(e => console.error("Save failed", e));
                        }, 1000); // 1ÁßíÂæåÊâç‰∏äÂÇ≥ÔºåÈÅøÂÖçÈ†ªÁπÅÂØ´ÂÖ•
                    } 
                    // LocalStorage Save (Backup)
                    if (type === 'schedule') localStorage.setItem('scheduleData', JSON.stringify(data));
                    if (type === 'shopping') localStorage.setItem('shoppingList', JSON.stringify(data));
                    if (type === 'expenses') localStorage.setItem('expenses', JSON.stringify(data));
                };

                // Áõ£ËÅΩËÆäÊõ¥‰∏¶Â≠òÊ™î
                watch(scheduleData, (newVal) => saveToCloud('schedule', newVal), { deep: true });
                watch(shoppingList, (newVal) => saveToCloud('shopping', newVal), { deep: true });
                watch(expenses, (newVal) => saveToCloud('expenses', newVal), { deep: true });

                // Computed Logic
                const currentFullDate = computed(() => tripDays[selectedDayIndex.value].fullDate);
                const filteredEvents = computed(() => {
                    const daily = scheduleData.value[selectedDayIndex.value] || [];
                    if (filterCategory.value === 'All') return daily;
                    return daily.filter(e => e.type === filterCategory.value);
                });
                const previousHotel = computed(() => {
                    if (selectedDayIndex.value === 0) return 'Sweet Home';
                    return hotelMap[selectedDayIndex.value - 1] || 'Unknown Hotel';
                });
                const weatherData = computed(() => {
                    const locationMap = { 0: { name: 'Tokyo', t: 8 }, 1: { name: 'Tokyo', t: 7 }, 2: { name: 'Tokyo', t: 9 }, 3: { name: 'Tokushima', t: 11 }, 4: { name: 'Kochi', t: 13 }, 5: { name: 'Matsuyama', t: 10 }, 6: { name: 'Takamatsu', t: 9 }, 7: { name: 'Takamatsu', t: 8 }, 8: { name: 'Taichung', t: 20 } };
                    const loc = locationMap[selectedDayIndex.value] || { name: 'Japan', t: 10 };
                    return { location: loc.name, temp: loc.t, feelsLike: loc.t - 2, icon: loc.t > 15 ? 'fa-solid fa-sun text-yellow-300' : 'fa-solid fa-cloud text-blue-200' };
                });
                const convertedCurrency = computed(() => !currencyInput.value ? 0 : Math.round(currencyInput.value * exchangeRate.value));
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount || 0), 0));

                // Helper Methods
                const getTransportIcon = (type) => type === 'walk' ? 'fa-solid fa-person-walking' : (type === 'car' ? 'fa-solid fa-car-side' : 'fa-solid fa-train-subway');
                const getCategoryIcon = (cat) => { const map = { food: 'fa-utensils', transport: 'fa-train', shopping: 'fa-bag-shopping', hotel: 'fa-bed', ticket: 'fa-ticket', other: 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const openMap = (query) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');

                // CRUD Actions
                const openAddModal = () => { isEditing.value = false; eventForm.value = { dayIndex: selectedDayIndex.value, type: 'sightseeing', transportType: 'walk', transportTime: '15 mins' }; showEventModal.value = true; };
                const editEvent = (event) => { isEditing.value = true; let dayIdx = -1; scheduleData.value.forEach((day, idx) => { if (day.find(e => e.id === event.id)) dayIdx = idx; }); eventForm.value = { ...event, dayIndex: dayIdx }; showEventModal.value = true; };
                const saveEvent = () => {
                    const targetDay = eventForm.value.dayIndex;
                    if (isEditing.value) scheduleData.value = scheduleData.value.map(day => day.filter(e => e.id !== eventForm.value.id));
                    if (!scheduleData.value[targetDay]) scheduleData.value[targetDay] = [];
                    scheduleData.value[targetDay].push({ ...eventForm.value, id: eventForm.value.id || Date.now() });
                    scheduleData.value[targetDay].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
                    closeEventModal();
                };
                const confirmDelete = () => { if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü')) { scheduleData.value = scheduleData.value.map(day => day.filter(e => e.id !== eventForm.value.id)); closeEventModal(); } };
                const closeEventModal = () => showEventModal.value = false;

                // Drag & Drop
                let dragStartIndex = -1;
                const dragStart = (index) => dragStartIndex = index;
                const drop = (index) => {
                    const list = scheduleData.value[selectedDayIndex.value];
                    const itemToMove = list[dragStartIndex];
                    list.splice(dragStartIndex, 1);
                    list.splice(index, 0, itemToMove);
                    dragStartIndex = -1;
                };

                // Image Handling (Resize before upload)
                const resizeImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 500; // Limit size for Firestore
                                const scale = maxWidth / img.width;
                                canvas.width = maxWidth;
                                canvas.height = img.height * scale;
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                resolve(canvas.toDataURL('image/jpeg', 0.7));
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                };
                const handleImageUpload = async (e) => {
                    const file = e.target.files[0];
                    if (file) shoppingForm.value.image = await resizeImage(file);
                };

                const addShoppingItem = () => { if (!shoppingForm.value.name) return; shoppingList.value.push({ ...shoppingForm.value, checked: false }); shoppingForm.value = { name: '', image: null }; showShoppingModal.value = false; };
                const deleteShoppingItem = (index) => { if(confirm('Âà™Èô§Ê≠§ÂïÜÂìÅ?')) shoppingList.value.splice(index, 1); };
                const toggleShopItem = (index) => { shoppingList.value[index].checked = !shoppingList.value[index].checked; };
                
                const addExpense = () => { if (!expenseForm.value.amount) return; expenses.value.unshift({ ...expenseForm.value }); expenseForm.value = { date: new Date().toISOString().split('T')[0], category: 'food', payment: 'Cash', amount: '' }; showExpenseModal.value = false; };

                return {
                    dbStatus, currentTab, tripDays, selectedDayIndex, filterCategory, currentFullDate, filteredEvents, previousHotel, weatherData, staticInfo, scheduleData,
                    showEventModal, isEditing, eventForm, openAddModal, editEvent, saveEvent, confirmDelete, closeEventModal,
                    dragStart, drop, exchangeRate, currencyInput, convertedCurrency, openMap,
                    showShoppingModal, shoppingForm, shoppingList, handleImageUpload, addShoppingItem, deleteShoppingItem, toggleShopItem,
                    showExpenseModal, expenseForm, expenses, addExpense, totalExpenses, getTransportIcon, getCategoryIcon
                };
            }
        }).mount('#app');
    </script>

    <style>
        /* ÂãïÁï´ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
    </style>
</body>
</html>